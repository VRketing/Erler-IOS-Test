var Follow=pc.createScript("follow");Follow.attributes.add("target",{type:"entity",title:"Target",description:"The Entity to follow"}),Follow.attributes.add("distance",{type:"number",default:4,title:"Distance",description:"How far from the Entity should the follower be"}),Follow.prototype.initialize=function(){this.vec=new pc.Vec3},Follow.prototype.update=function(t){if(this.target){var e=this.target.getPosition();e.x+=.75*this.distance,e.y+=1*this.distance,e.z+=.75*this.distance,this.vec.lerp(this.vec,e,.1),this.entity.setPosition(this.vec)}};var Movement=pc.createScript("movement");Movement.attributes.add("speed",{type:"number",default:.1,min:.05,max:.5,precision:2,description:"Controls the movement speed"}),Movement.prototype.initialize=function(){this.force=new pc.Vec3},Movement.prototype.update=function(e){var t=0,s=0;if(console.log(this.speed),this.app.keyboard.isPressed(pc.KEY_LEFT)&&(t=-this.speed),this.app.keyboard.isPressed(pc.KEY_RIGHT)&&(t+=this.speed),this.app.keyboard.isPressed(pc.KEY_UP)&&(s=-this.speed),this.app.keyboard.isPressed(pc.KEY_DOWN)&&(s+=this.speed),this.force.x=t,this.force.z=s,this.force.length()){var i=Math.cos(.25*-Math.PI),o=Math.sin(.25*-Math.PI);this.force.set(this.force.x*i-this.force.z*o,0,this.force.z*i+this.force.x*o),this.force.length()>this.speed&&this.force.normalize().scale(this.speed)}this.entity.rigidbody.applyImpulse(this.force)};var Teleportable=pc.createScript("teleportable");Teleportable.prototype.initialize=function(){this.lastTeleportFrom=null,this.lastTeleportTo=null,this.lastTeleport=Date.now(),this.startPosition=this.entity.getPosition().clone()},Teleportable.prototype.update=function(t){this.entity.getPosition().y<0&&this.teleport(this.lastTeleportFrom,this.lastTeleportTo)},Teleportable.prototype.teleport=function(t,e){var o;t&&Date.now()-this.lastTeleport<500||(this.lastTeleport=Date.now(),this.lastTeleportFrom=t,this.lastTeleportTo=e,e?(o=e.getPosition()).y+=.5:o=this.startPosition,this.entity.rigidbody.teleport(o),this.entity.rigidbody.linearVelocity=pc.Vec3.ZERO,this.entity.rigidbody.angularVelocity=pc.Vec3.ZERO)};var Teleport=pc.createScript("teleport");Teleport.attributes.add("target",{type:"entity",title:"Target Entity",description:"The target entity where we are going to teleport"}),Teleport.prototype.initialize=function(){this.target&&this.entity.collision.on("triggerenter",this.onTriggerEnter,this)},Teleport.prototype.onTriggerEnter=function(t){t.script.teleportable&&t.script.teleportable.teleport(this.entity,this.target)};var VideoTexture=pc.createScript("videoTexture");VideoTexture.attributes.add("playEvent",{title:"Play Event",description:"Event that is fired as soon as the video texture is ready to play.",type:"string",default:""}),VideoTexture.prototype.initialize=function(){var e=this.app,t=document.createElement("video");navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}})&&navigator.mediaDevices.getUserMedia({video:!0}).then((function(e){t.srcObject=e})).catch((function(){console.log("Something went wrong!")})),t.loop=!0,t.muted=!0,t.playsInline=!0,t.crossOrigin="anonymous",t.autoplay=!0;var i=t.style;i.width="1px",i.height="1px",i.position="absolute",i.opacity="0",i.zIndex="-1000",i.pointerEvents="none",document.body.appendChild(t),this.videoTexture=new pc.Texture(e.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8,minFilter:pc.FILTER_LINEAR_MIPMAP_LINEAR,magFilter:pc.FILTER_LINEAR,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE,mipmaps:!0}),this.videoTexture.setSource(t),t.addEventListener("canplaythrough",function(i){e.fire(this.playEvent,this.videoTexture),t.play()}.bind(this)),t.src=this.video?this.video.getFileUrl():this.videoUrl,document.body.appendChild(t),t.load()},VideoTexture.prototype.update=function(e){this.videoTexture.upload()};var Manager=pc.createScript("manager");Manager.attributes.add("template",{title:"Template",type:"entity"}),Manager.attributes.add("numClones",{title:"Num Clones",type:"number",default:50}),Manager.attributes.add("spread",{title:"Spread",type:"number",default:10}),Manager.prototype.initialize=function(){this.entities=[];for(var t=0;t<this.numClones;t++){var e=this.template.clone();e.enabled=!0,this.app.root.addChild(e),this.entities.push(e),this.reset(e)}},Manager.prototype.update=function(t){this.entities.forEach((function(t){t.getPosition().y<-10&&this.reset(t)}),this)},Manager.prototype.reset=function(t){var e=this.entity.getPosition();t.rigidbody.linearVelocity=pc.Vec3.ZERO,t.rigidbody.angularVelocity=pc.Vec3.ZERO,t.rigidbody.teleport(e.x+(Math.random()-.5)*this.spread,e.y,e.z+(Math.random()-.5)*this.spread)};var TvScreen=pc.createScript("tvScreen");TvScreen.attributes.add("screenMaterial",{title:"Screen Material",description:"The screen material of the TV that displays the video texture.",type:"asset",assetType:"material"}),TvScreen.attributes.add("playEvent",{title:"Play Event",description:"Set the TV screen material emissive map on this event.",type:"string",default:""}),TvScreen.prototype.initialize=function(){this.app.on(this.playEvent,(function(e){var t=this.screenMaterial.resource;t.emissiveMap=e,t.update()}),this)};var LocalVideo=pc.createScript("localVideo");LocalVideo.attributes.add("playEvent",{title:"Play Event",description:"Event that is fired as soon as the video texture is ready to play.",type:"string",default:""}),LocalVideo.attributes.add("lerpSpeed",{title:"Lerp Speed",description:"Speed to adjust how fast the cropping to detected face is adjusted.",type:"number",default:2}),LocalVideo.attributes.add("useFaceCrop",{title:"Use Face Crop",description:"Weather to use face detection to crop face or not",type:"boolean",default:!0}),LocalVideo.prototype.useCustomCanvas=function(e){this.canvas.remove(),this.canvas=e,this.ctx=this.canvas.getContext("2d")},LocalVideo.prototype.initialize=function(){this.lerpSpeed=30;this.app;var e=this;e.cropArea=[[0,0],[0,0]],e.cropTarget=[[0,0],[0,0]],e.lerpedCrop=[[0,0],[0,0]],e.faceReady=!1,e.videoPlaying=!1,e.lerpVal=0,this.useFaceCrop&&(e.workerScript=this.app.assets.find("tfjs-faceDetection-worker.js"),e.worker=new Worker(e.workerScript.getFileUrl())),e.video=document.createElement("video"),e.canvas=document.createElement("canvas"),e.canvasSrc=document.createElement("canvas"),e.video.loop=!0,e.video.muted=!0,e.video.playsInline=!0;var t=e.video.style;t.width="1px",t.height="1px",t.position="absolute",t.opacity="0",t.zIndex="-1000",t.pointerEvents="none",document.body.appendChild(e.video),e.canvas.style.width="500",e.canvas.style.height="500px",e.canvas.style.position="absolute",e.canvas.width=256,e.canvas.height=256,e.ctx=e.canvas.getContext("2d"),document.body.appendChild(e.canvas),e.canvasSrc.style.visibility="hidden",e.canvasSrc.style.width="1px",e.canvasSrc.style.height="1px",e.ctxSrc=e.canvasSrc.getContext("2d"),document.body.appendChild(e.canvasSrc);navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),navigator.mediaDevices.getUserMedia({audio:!1,video:!0}).then(function(t){e.video.srcObject=t,e.video.onloadeddata=function(t){e.canvasSrc.width=this.videoWidth,e.canvasSrc.height=this.videoHeight},window.addEventListener("resize",(function(t){e.canvasSrc.width=e.video.videoWidth,e.canvasSrc.height=e.video.videoHeight})),e.video.addEventListener("canplaythrough",function(t){e.fire(e.playEvent,e.canvas),e.video.play(),e.videoPlaying=!0,this.useFaceCrop?(console.log("Face follow speed is: "+this.lerpSpeed),e.worker.addEventListener("message",(t=>{e.faceReady=!0,t.data&&(e.lerpVal=0,e.cropArea=e.lerpedCrop,e.cropTarget=t.data),e.processFrame()})),e.processFrame()):e.faceReady=!0}.bind(e))}.bind(e)).catch((function(e){console.log(e.name+": "+e.message)})),e.entity.on("video:input",(t=>{console.log("setting new video device: "+t);var i={audio:!1,video:{deviceId:t}};navigator.mediaDevices.getUserMedia(i).then(function(t){e.video.srcObject=t}.bind(e))}),e),e.video.addEventListener("play",(function(){}),!1),this.on("destroy",(()=>{this.worker&&this.worker.terminate(),this.canvas.remove(),this.canvasSrc.remove(),this.video.remove()}),this)},LocalVideo.prototype.processFrame=function(){if(this.videoPlaying){this.ctxSrc.drawImage(this.video,0,0,this.canvasSrc.width,this.canvasSrc.height);var e=this.ctxSrc.getImageData(0,0,this.canvasSrc.width,this.canvasSrc.height).data;this.worker.postMessage({data:e,width:this.canvasSrc.width,height:this.canvasSrc.height})}},LocalVideo.prototype.update=function(e){this.faceReady&&(this.useFaceCrop?this.updateVideoCanvas(e):this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height))},LocalVideo.prototype.updateVideoCanvas=function(e){var t=Math.max(Math.abs(this.lerpedCrop[0][0]-this.cropTarget[0][0]),Math.abs(this.lerpedCrop[1][1]-this.cropTarget[1][1]),Math.abs(this.lerpedCrop[0][1]-this.cropTarget[0][1]),Math.abs(this.lerpedCrop[1][0]-this.cropTarget[1][0]));this.lerpVal+=e*this.lerpSpeed*t,this.lerpedCrop[0][0]=pc.math.lerp(this.cropArea[0][0],this.cropTarget[0][0],this.lerpVal),this.lerpedCrop[0][1]=pc.math.lerp(this.cropArea[0][1],this.cropTarget[0][1],this.lerpVal),this.lerpedCrop[1][0]=pc.math.lerp(this.cropArea[1][0],this.cropTarget[1][0],this.lerpVal),this.lerpedCrop[1][1]=pc.math.lerp(this.cropArea[1][1],this.cropTarget[1][1],this.lerpVal);var i=this.lerpedCrop[1][0]-this.lerpedCrop[0][0],a=this.lerpedCrop[1][1]-this.lerpedCrop[0][1];this.ctx.drawImage(this.video,this.lerpedCrop[0][0]*this.video.videoWidth,this.lerpedCrop[0][1]*this.video.videoHeight,i*this.video.videoWidth,a*this.video.videoHeight,0,0,this.canvas.width,this.canvas.height)};